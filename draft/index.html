<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>js to wasm array</title>
  </head>
  <body>

    <script type="text/javascript">
      function getRandomArbitrary() {
        return Math.random();
      }

      var Module = {
        onRuntimeInitialized: function() {
          // size of array
          const n = 1000;

          // still doesn't work
          // const test = new Float64Array(n);
          // test.set(test.map(() => getRandomArbitrary()));

          // let buffer = Module._malloc(test.length * test.BYTES_PER_ELEMENT);
          // Module.HEAPF64.set(test, buffer >> 2);

          // var nrow = 50, ncol = 20;
          // var instance = new Module.NumericMatrix(nrow, ncol, test.byteOffset);
          // console.log('Matrix dimensions: ' + instance.nrow() + ' ' + instance.ncol());

          // const dim = new Float64Array(ncol);

          // instance.column(0, dim.byteOffset);
          // console.log("First matrix entry: " + dim[0]);

          // instance.delete();

          // eventually figured out the Module initialized memory space
          Module["wasmMemory"] = Module["asm"]["memory"];

          let offset = 0;
          const mat0 = new Float64Array(
            Module["wasmMemory"].buffer,
            offset,
            n
          );
          mat0.set(mat0.map(() => getRandomArbitrary()));
          
          var nrow = 50, ncol = 20;

          var instance = new Module.NumericMatrix(nrow, ncol, mat0.byteOffset);
          console.log('Matrix dimensions: ' + instance.nrow() + ' ' + instance.ncol());

          offset += mat0.byteLength;
          const dim = new Float64Array(
            Module["wasmMemory"].buffer,
            offset,
            ncol
          );
          instance.column(0, dim.byteOffset);
          console.log("First matrix entry: " + dim[0]);

          instance.delete();
        }
      };
    </script>
    <script src="target.js"></script>
  </body>
</html>
